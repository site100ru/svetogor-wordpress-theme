(function(){'use strict';const RECAPTCHA_SITE_KEY='6LdV1IcUAAAAADRQAhpGL8dVj5_t0nZDPh9m_0tn';let recaptchaLoaded=false;let recaptchaWidgets=new Map();function loadRecaptchaAPI(){return new Promise((resolve,reject)=>{if(typeof grecaptcha!=='undefined'&&grecaptcha.render){recaptchaLoaded=true;resolve();return}const existingScripts=document.querySelectorAll('script[src*="recaptcha"]');existingScripts.forEach(script=>script.remove());const script=document.createElement('script');script.src='https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit';script.async=true;script.defer=true;window.onRecaptchaLoad=function(){recaptchaLoaded=true;resolve()};script.onerror=function(){reject(new Error('Ошибка загрузки reCAPTCHA API'))};document.head.appendChild(script)})}function initializeForms(){const customForm=document.getElementById('custom-contact-form');if(customForm&&!customForm.hasAttribute('data-recaptcha-initialized')){initializeCustomForm(customForm)}const extendedForm=document.getElementById('extended-contact-form');if(extendedForm&&!extendedForm.hasAttribute('data-recaptcha-initialized')){initializeExtendedForm(extendedForm)}}function initializeCustomForm(form){form.setAttribute('data-recaptcha-initialized','true');const submitBtn=document.getElementById('submit-btn');const btnText=submitBtn.querySelector('.btn-text');const btnSpinner=submitBtn.querySelector('.btn-spinner');const messagesDiv=document.getElementById('form-messages');fillHiddenFields(form);setupFileUpload(form);const recaptchaContainer=form.querySelector('.g-recaptcha');if(recaptchaContainer&&recaptchaLoaded){const widgetId=grecaptcha.render(recaptchaContainer,{'sitekey':RECAPTCHA_SITE_KEY});recaptchaWidgets.set(form,widgetId)}form.addEventListener('submit',function(e){e.preventDefault();clearMessages(messagesDiv);clearValidation(form);if(!validateCustomForm(form)){return}const widgetId=recaptchaWidgets.get(form);const recaptchaResponse=widgetId!==undefined?grecaptcha.getResponse(widgetId):'';if(!recaptchaResponse){showMessage(messagesDiv,'Пожалуйста, подтвердите, что вы не робот','danger');return}setLoadingState(submitBtn,btnText,btnSpinner,true);const formData=new FormData(form);formData.append('action','submit_custom_contact_form');formData.append('nonce',customForm.nonce);formData.append('g-recaptcha-response',recaptchaResponse);fetch(customForm.ajaxUrl,{method:'POST',body:formData}).then(response=>response.json()).then(data=>{setLoadingState(submitBtn,btnText,btnSpinner,false);if(data.success){showMessage(messagesDiv,data.data.message||'Спасибо! Ваша заявка отправлена. Мы свяжемся с вами в ближайшее время.','success');resetForm(form,messagesDiv)}else{showMessage(messagesDiv,data.data||'Произошла ошибка при отправке. Попробуйте еще раз.','danger')}if(widgetId!==undefined){grecaptcha.reset(widgetId)}}).catch(error=>{setLoadingState(submitBtn,btnText,btnSpinner,false);showMessage(messagesDiv,'Произошла ошибка при отправке. Попробуйте еще раз.','danger');if(widgetId!==undefined){grecaptcha.reset(widgetId)}})})}function initializeExtendedForm(form){form.setAttribute('data-recaptcha-initialized','true');const submitBtn=document.getElementById('extended-submit-btn');const btnText=submitBtn.querySelector('.btn-text');const btnSpinner=submitBtn.querySelector('.btn-spinner');const messagesDiv=document.getElementById('extended-form-messages');fillHiddenFields(form);setupFileUpload(form);setupAllCheckboxes(form);const recaptchaContainer=form.querySelector('.g-recaptcha');if(recaptchaContainer&&recaptchaLoaded){const widgetId=grecaptcha.render(recaptchaContainer,{'sitekey':RECAPTCHA_SITE_KEY});recaptchaWidgets.set(form,widgetId)}form.addEventListener('submit',function(e){e.preventDefault();clearMessages(messagesDiv);clearValidation(form);if(!validateExtendedForm(form)){return}const widgetId=recaptchaWidgets.get(form);const recaptchaResponse=widgetId!==undefined?grecaptcha.getResponse(widgetId):'';if(!recaptchaResponse){showMessage(messagesDiv,'Пожалуйста, подтвердите, что вы не робот','danger');return}setLoadingState(submitBtn,btnText,btnSpinner,true);const formData=new FormData(form);formData.append('action','submit_extended_contact_form');formData.append('nonce',extendedForm.nonce);formData.append('g-recaptcha-response',recaptchaResponse);fetch(extendedForm.ajaxUrl,{method:'POST',body:formData}).then(response=>response.json()).then(data=>{setLoadingState(submitBtn,btnText,btnSpinner,false);if(data.success){showMessage(messagesDiv,data.data.message||'Спасибо! Ваша заявка отправлена. Мы свяжемся с вами в ближайшее время.','success');resetExtendedForm(form,messagesDiv)}else{showMessage(messagesDiv,data.data||'Произошла ошибка при отправке. Попробуйте еще раз.','danger')}if(widgetId!==undefined){grecaptcha.reset(widgetId)}}).catch(error=>{setLoadingState(submitBtn,btnText,btnSpinner,false);showMessage(messagesDiv,'Произошла ошибка при отправке. Попробуйте еще раз.','danger');if(widgetId!==undefined){grecaptcha.reset(widgetId)}})})}function fillHiddenFields(form){const pageUrl=form.querySelector('input[name="page-url"]');const pageTitle=form.querySelector('input[name="page-title"]');const referrer=form.querySelector('input[name="referrer"]');const userAgent=form.querySelector('input[name="user-agent"]');if(pageUrl)pageUrl.value=window.location.href;if(pageTitle)pageTitle.value=document.title;if(referrer)referrer.value=document.referrer||'';if(userAgent)userAgent.value=navigator.userAgent}function setupFileUpload(form){const fileInput=form.querySelector('.file-upload');const fileName=form.querySelector('.file-name');if(fileInput&&fileName){fileInput.addEventListener('change',function(e){if(e.target.files&&e.target.files.length>0){const file=e.target.files[0];const maxSize=5*1024*1024;if(file.size>maxSize){const messagesDiv=form.querySelector('#form-messages, #extended-form-messages');showMessage(messagesDiv,'Размер файла не должен превышать 5MB','danger');this.value='';fileName.textContent='Файл не прикреплен';return}fileName.textContent=file.name}else{fileName.textContent='Файл не прикреплен'}})}}function setupAllCheckboxes(form){const imageContainers=form.querySelectorAll('.image-checkbox-container');imageContainers.forEach(container=>{const checkbox=container.querySelector('input[type="checkbox"]');if(checkbox){container.addEventListener('click',function(e){if(e.target!==checkbox){e.preventDefault();checkbox.checked=!checkbox.checked;updateCheckboxState(container,checkbox)}});checkbox.addEventListener('change',function(){updateCheckboxState(container,checkbox)});updateCheckboxState(container,checkbox)}});const textContainers=form.querySelectorAll('.custom-checkbox-container');textContainers.forEach(container=>{const checkbox=container.querySelector('input[type="checkbox"]');if(checkbox){container.addEventListener('click',function(e){if(e.target!==checkbox){e.preventDefault();checkbox.checked=!checkbox.checked;updateCheckboxState(container,checkbox)}});checkbox.addEventListener('change',function(){updateCheckboxState(container,checkbox)});updateCheckboxState(container,checkbox)}})}function updateCheckboxState(container,checkbox){if(checkbox.checked){container.classList.add('active')}else{container.classList.remove('active')}}function validateCustomForm(form){let isValid=true;const name=form.querySelector('input[name="your-name"]');if(!name.value.trim()){markFieldInvalid(name);isValid=false}const phone=form.querySelector('input[name="your-phone"]');const phoneRegex=/^[\+]?[1-9][\d]{0,15}$/;if(!phone.value.trim()||!phoneRegex.test(phone.value.replace(/[\s\-\(\)]/g,''))){markFieldInvalid(phone);isValid=false}const email=form.querySelector('input[name="your-email"]');const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!email.value.trim()||!emailRegex.test(email.value)){markFieldInvalid(email);isValid=false}return isValid}function validateExtendedForm(form){let isValid=true;const name=form.querySelector('input[name="your-name"]');if(!name.value.trim()){markFieldInvalid(name);isValid=false}const phone=form.querySelector('input[name="your-phone"]');const phoneRegex=/^[\+]?[1-9][\d]{0,15}$/;if(!phone.value.trim()||!phoneRegex.test(phone.value.replace(/[\s\-\(\)]/g,''))){markFieldInvalid(phone);isValid=false}const email=form.querySelector('input[name="your-email"]');const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!email.value.trim()||!emailRegex.test(email.value)){markFieldInvalid(email);isValid=false}const productType=form.querySelector('select[name="product-type"]');if(productType&&!productType.value){markFieldInvalid(productType);isValid=false}return isValid}function markFieldInvalid(field){field.classList.add('is-invalid');const removeInvalid=function(){field.classList.remove('is-invalid')};field.addEventListener('input',removeInvalid,{once:true});if(field.tagName==='SELECT'){field.addEventListener('change',removeInvalid,{once:true})}}function clearValidation(form){form.querySelectorAll('.is-invalid').forEach(field=>{field.classList.remove('is-invalid')})}function setLoadingState(submitBtn,btnText,btnSpinner,loading){if(loading){submitBtn.disabled=true;if(btnText)btnText.style.display='none';if(btnSpinner)btnSpinner.style.display='inline-block'}else{submitBtn.disabled=false;if(btnText)btnText.style.display='inline-block';if(btnSpinner)btnSpinner.style.display='none'}}function showMessage(messagesDiv,message,type){if(messagesDiv){messagesDiv.innerHTML=`<div class="alert alert-${type}">${message}</div>`;messagesDiv.scrollIntoView({behavior:'smooth',block:'nearest'})}}function clearMessages(messagesDiv){if(messagesDiv){messagesDiv.innerHTML=''}}function resetForm(form,messagesDiv){form.reset();form.querySelectorAll('.image-checkbox-container input[type="checkbox"]').forEach(checkbox=>{checkbox.checked=false});const fileName=form.querySelector('.file-name');if(fileName){fileName.textContent='Файл не прикреплен'}clearValidation(form)}function resetExtendedForm(form,messagesDiv){form.reset();form.querySelectorAll('.image-checkbox-container, .custom-checkbox-container').forEach(container=>{container.classList.remove('active')});const fileName=form.querySelector('.file-name');if(fileName){fileName.textContent='Файл не прикреплен'}clearValidation(form)}document.addEventListener('DOMContentLoaded',function(){loadRecaptchaAPI().then(()=>{initializeForms()}).catch((error)=>{console.error('Ошибка загрузки reCAPTCHA:',error);initializeForms()})})})();